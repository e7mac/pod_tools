#!/usr/bin/env ruby

if RUBY_VERSION > '1.8.7' && Encoding.default_external != Encoding::UTF_8
  puts "\e[33mWARNING: CocoaPods requires your terminal to be using UTF-8 encoding."
  if ENV["TRAVIS"]
    puts <<-DOC
Consider adding the following settings to .travis.yml

before_script:
  - export LANG=en_US.UTF-8\e[0m\n
    DOC
  else
    puts <<-DOC
See https://github.com/CocoaPods/guides.cocoapods.org/issues/26 for
possible solutions.\e[0m\n
    DOC
  end
end

STDOUT.sync = true if ENV['CP_STDOUT_SYNC'] == 'TRUE'

require 'cocoapods'
require 'cocoapods-core'
# require 'pry'

podspecs = Dir.glob("*.podspec")
exit if podspecs.empty?

system "$EDITOR #{podspecs[0]}"

path = File.expand_path("~/.cocoapods/repos")
repos = Dir.glob("#{path}/*")
push_to_repo = ""
repos.each do |repo|
  repo_name = File.split(repo)[1]
  if repo_name != 'master' 
    push_to_repo = repo_name
  end 
end

spec = Pod::Specification::from_file(podspecs[0])
version = spec.version.to_s
puts "Committing the new podspec file."
system "git add #{podspecs[0]}"
system "git commit -m 'Changed the version of the podspec to #{version}'"

puts "Tagging version to #{version}."
system "git tag -a '#{version}' -m 'Tagged to #{version} before pod pushing'"

puts "Pushing to github."
system "git push --tags origin master"

puts "Pushing #{podspecs[0]} to the spec repository at #{push_to_repo}."
system "pod push #{push_to_repo} #{podspecs[0]}"

